<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Filament Inventory (HTML Prototype)</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#101a2c;
      --panel2:#0f172a;
      --panelSolid:#0c1323;
      --border:rgba(255,255,255,.10);
      --border2:rgba(255,255,255,.14);
      --text:#e6edf7;
      --muted:rgba(230,237,247,.68);
      --accent:#3b82f6;
      --danger:#ef4444;
      --warn:#f59e0b;
      --ok:#10b981;
      --shadow: 0 18px 55px rgba(0,0,0,.52);
      --radius:16px;
      --radiusSm:12px;
      --focus: 0 0 0 3px rgba(59,130,246,.35);
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:
        radial-gradient(1200px 600px at 30% -10%, rgba(59,130,246,.18), transparent 60%),
        radial-gradient(900px 500px at 90% 10%, rgba(16,185,129,.10), transparent 55%),
        var(--bg);
      color:var(--text);
      font-family:var(--font);
    }
    .wrap{max-width:1280px;margin:0 auto;padding:22px}

    /* Top nav */
    .topnav{
      display:flex;gap:12px;align-items:center;
      padding:12px;
      border:1px solid var(--border);
      border-radius:22px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
    }
    .navbtn{
      flex:1;
      display:flex;gap:10px;align-items:center;justify-content:center;
      padding:14px 14px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
      cursor:pointer;
      font-weight:800;
      color:var(--text);
      user-select:none;
    }
    .navbtn.active{
      background: rgba(59,130,246,.22);
      border-color: rgba(59,130,246,.40);
    }
    .navbtn:hover{filter:brightness(1.06)}
    .navbtn:focus{outline:none; box-shadow: var(--focus)}
    .navicon{opacity:.9}

    /* Generic header card */
    .pageHeader{
      margin-top:16px;
      border:1px solid var(--border);
      border-radius:22px;
      background: rgba(255,255,255,.03);
      padding:18px 18px;
    }
    .pageHeader h1{margin:0;font-size:28px;letter-spacing:.2px}
    .pageHeader .sub{color:var(--muted);font-size:12px;margin-top:6px}

    /* Buttons & inputs */
    .btn{
      border:1px solid var(--border);
      background: rgba(255,255,255,.05);
      color:var(--text);
      padding:10px 12px;border-radius:12px;
      cursor:pointer;
      font-weight:800;
    }
    .btn.primary{background: rgba(59,130,246,.18); border-color: rgba(59,130,246,.40)}
    .btn.danger{background: rgba(239,68,68,.16); border-color: rgba(239,68,68,.40)}
    .btn:focus{outline:none; box-shadow: var(--focus)}
    .btn:hover{filter:brightness(1.08)}
    .input, select, textarea{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      color:var(--text);
      padding:11px 12px;border-radius:12px;
      width:100%;
    }
    .input:focus, select:focus, textarea:focus{outline:none; box-shadow:var(--focus)}
    textarea{min-height:110px;resize:vertical}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:8px;font-weight:700}
    .req::after{content:" *"; color:rgba(230,237,247,.85)}

    /* Inventory */
    .kpis{
      display:grid;grid-template-columns: repeat(3, minmax(0,1fr));
      gap:14px;margin-top:14px;
    }
    .kpi{
      border:1px solid var(--border);border-radius:18px;
      background: rgba(255,255,255,.03);
      padding:14px 16px;
      display:flex;align-items:center;justify-content:space-between;
    }
    .kpi .label{color:var(--muted);font-size:12px}
    .kpi .value{font-size:28px;font-weight:900;color:#93c5fd}

    .strip{
      margin-top:14px;
      border:1px solid rgba(245,158,11,.25);
      background: rgba(245,158,11,.10);
      border-radius:18px;
      padding:12px 14px;
      display:flex;gap:12px;align-items:center;justify-content:space-between;
    }
    .strip .left{display:flex;gap:10px;align-items:center}
    .pill{
      padding:6px 10px;border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      color:var(--text);
      font-size:12px;font-weight:900;
      letter-spacing:.2px;
    }
    .pill.warn{background: rgba(245,158,11,.18); border-color: rgba(245,158,11,.35)}
    .pill.danger{background: rgba(239,68,68,.18); border-color: rgba(239,68,68,.35)}
    .pill.ok{background: rgba(16,185,129,.14); border-color: rgba(16,185,129,.30)}
    .controls{
      margin-top:16px;
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;
    }
    .controls .input{width:320px}
    .spacer{flex:1}

    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(185px, 1fr));
      gap:12px;
    }
    .tile{
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      border-radius: 18px;
      overflow:hidden;
      cursor:pointer;
      position:relative;
      transition: transform .12s ease, filter .12s ease;
      min-height:150px;
    }

    /* Status ‚Äúrail‚Äù on the left edge of tile */
    .tile::before{
      content:"";
      position:absolute;left:0;top:0;bottom:0;
      width:4px;
      background: rgba(255,255,255,.10);
    }
    .tile.ok::before{ background: rgba(16,185,129,.90); }
    .tile.low::before{ background: rgba(245,158,11,.95); }
    .tile.critical::before{ background: rgba(239,68,68,.98); }

    .tile:hover{transform: translateY(-2px); filter:brightness(1.06)}
    .tile:focus{outline:none; box-shadow: var(--focus)}
    
    /* STATUS BADGE EMBEDDED IN SWATCH */
    .swatch{
      height:34px;
      background: var(--swatch, #64748b);
      position:relative;
      display:flex;
      align-items:center;
      justify-content:flex-end;
      padding-right:8px;
    }
    .swatch::after{
      content:"";position:absolute;inset:0;
      background: linear-gradient(180deg, rgba(255,255,255,.20), rgba(255,255,255,0));
      pointer-events:none;
    }
    .tileBody{padding:12px}
    .brand{color:var(--muted);font-size:12px}
    .nameRow{display:flex;justify-content:space-between;gap:10px;align-items:flex-start;margin-top:2px}
    .name{font-weight:900;line-height:1.15}
    .pct{font-weight:900;font-size:18px}

    .meta{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
    .tag{
      font-size:11px;font-weight:900;
      padding:4px 8px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      color:rgba(230,237,247,.88);
    }

    /* Type/Finish chips now take their colors from CSS variables */
    .tag.type{
      border-color: var(--typeBorder, rgba(16,185,129,.35));
      background: var(--typeBg, rgba(16,185,129,.12));
    }
    .tag.finish{
      border-color: var(--finishBorder, rgba(59,130,246,.35));
      background: var(--finishBg, rgba(59,130,246,.12));
    }

    .tag.ready{border-color: rgba(14,116,144,.35); background: rgba(14,116,144,.16)}
    .tag.refill{border-color: rgba(148,163,184,.30); background: rgba(148,163,184,.10)}

    .barWrap{
      margin-top:10px;height:10px;border-radius:999px;
      background: rgba(255,255,255,.08);
      overflow:hidden;border:1px solid rgba(255,255,255,.06);
    }
    .bar{
      height:100%;
      width: var(--pct, 50%);
      background: linear-gradient(90deg, rgba(16,185,129,.95), rgba(59,130,246,.95));
      border-radius:999px;
      transition: width .25s ease;
    }
    .bar.low{background: linear-gradient(90deg, rgba(245,158,11,.98), rgba(239,68,68,.95))}
    .tileFooter{
      margin-top:8px;display:flex;justify-content:space-between;gap:8px;align-items:center;
      color:var(--muted);font-size:12px;
    }

    /* Badge now sits inside swatch */
    .badge{
      position:relative; /* no absolute */
      padding:5px 10px;
      border-radius:999px;

      font-size:11px;
      font-weight:1000;
      letter-spacing:.5px;
      text-transform:uppercase;

      display:flex;
      align-items:center;
      gap:6px;

      backdrop-filter: blur(6px);
      background: rgba(0,0,0,.55);
      color:#fff;

      border:1px solid rgba(255,255,255,.25);

      box-shadow:
        0 4px 12px rgba(0,0,0,.45),
        inset 0 1px 0 rgba(255,255,255,.25);
    }

    /* STATUS COLORS (stronger visibility) */
    .tile.ok .badge{
      background: rgba(16,185,129,.85);
      border-color: rgba(16,185,129,1);
    }

    .tile.low .badge{
      background: rgba(245,158,11,.90);
      border-color: rgba(245,158,11,1);
    }

    .tile.critical .badge{
      background: rgba(239,68,68,.95);
      border-color: rgba(239,68,68,1);
    }

    .stackBadge{
      position:absolute;top:10px;left:10px;
      padding:6px 10px;border-radius:999px;
      font-size:11px;font-weight:1000;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.28);
      letter-spacing:.2px;
      display:none;
    }
    .tile.stacked .stackBadge{display:block}

    /* Stronger status glow */
    .tile.ok{box-shadow: 0 0 0 1px rgba(16,185,129,.16), 0 10px 30px rgba(16,185,129,.05)}
    .tile.low{box-shadow: 0 0 0 1px rgba(245,158,11,.22), 0 10px 30px rgba(245,158,11,.08)}
    .tile.critical{box-shadow: 0 0 0 1px rgba(239,68,68,.26), 0 10px 30px rgba(239,68,68,.10)}

    /* Modal (solid) */
    .backdrop{
      position:fixed;inset:0;
      background: rgba(0,0,0,.72);
      display:none;
      align-items:center;justify-content:center;
      padding:18px;
      backdrop-filter: blur(2px);
    }
    .backdrop.show{display:flex}
    .modal{
      width:min(860px, 100%);
      border:1px solid rgba(255,255,255,.14);
      background: var(--panelSolid);
      border-radius: 22px;
      box-shadow: 0 25px 80px rgba(0,0,0,.70);
      overflow:hidden;
    }
    .modalHeader{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
    }
    .modalTitle{display:flex;gap:12px;align-items:center}
    .modalSwatch{
      width:20px;height:20px;border-radius:7px;
      background: var(--swatch, #64748b);
      border:1px solid rgba(255,255,255,.20);
    }
    .modal h2{margin:0;font-size:16px;font-weight:950}
    .modal .sub{color:var(--muted);font-size:12px;margin-top:2px}
    .iconBtn{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      width:40px;height:40px;border-radius:12px;
      cursor:pointer;color:var(--text);
      font-weight:1000;
    }
    .iconBtn:hover{filter:brightness(1.1)}
    .modalBody{padding:16px}
    .twoCol{display:grid;grid-template-columns: 1.05fr .95fr;gap:14px}
    .panel{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      border-radius: 16px;
      padding:12px;
    }
    .panelTitle{font-weight:950;margin-bottom:10px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
    .field{flex:1;min-width:160px}
    .help{color:var(--muted);font-size:12px;margin-top:8px}

    /* Group spool list */
    .spoolList{display:flex;flex-direction:column;gap:10px;margin-top:10px}
    .spoolRow{
      display:flex;gap:10px;align-items:center;justify-content:space-between;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      padding:10px 10px;border-radius:14px;
    }
    .spoolRow .left{
      display:flex;gap:10px;align-items:center;min-width:0;
    }
    .miniSwatch{
      width:12px;height:12px;border-radius:4px;background:var(--swatch);
      border:1px solid rgba(255,255,255,.18);
    }
    .spoolRow .title{
      font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
      max-width:360px;
    }
    .spoolRow .subline{color:var(--muted);font-size:12px;margin-top:2px}
    .spoolRow .right{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
    .tinyBtn{
      padding:8px 10px;border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color:var(--text);
      font-weight:900;
      cursor:pointer;
    }
    .tinyBtn.primary{border-color: rgba(59,130,246,.40); background: rgba(59,130,246,.18)}
    .tinyBtn:hover{filter:brightness(1.1)}

    .modalFooter{
      display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;
      padding:14px 16px;
      border-top:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
    }

    /* Add form layout */
    .formCard{
      margin-top:14px;
      border:1px solid var(--border);
      border-radius:22px;
      background: rgba(255,255,255,.03);
      padding:16px;
    }
    .formGrid{
      margin-top:12px;
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap:14px;
    }
    .colSpan2{grid-column: span 2}
    .colSpan3{grid-column: span 3}
    .colSpan4{grid-column: span 4}

    .colorRow{
      display:flex;gap:10px;align-items:flex-end;
    }
    .colorPreview{
      width:46px;height:40px;border-radius:12px;
      border:1px solid rgba(255,255,255,.18);
      background:#000;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.25);
    }
    .checkRow{
      display:flex;gap:10px;align-items:center;margin-top:6px;
      color:var(--text);font-weight:800;
    }
    .checkRow input{width:18px;height:18px}
    .formFooter{
      display:flex;gap:10px;margin-top:14px;flex-wrap:wrap;
    }

    /* Responsive */
    @media (max-width: 980px){
      .kpis{grid-template-columns:1fr}
      .twoCol{grid-template-columns:1fr}
      .controls .input{width:100%}
      .formGrid{grid-template-columns: 1fr 1fr}
      .colSpan2,.colSpan3,.colSpan4{grid-column: span 2}
      .navbtn{padding:12px}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <!-- Top Nav -->
    <div class="topnav">
      <button class="navbtn active" id="navInventory"><span class="navicon">üì¶</span> Inventory</button>
      <button class="navbtn" id="navAdd"><span class="navicon">‚ûï</span> Add Filament</button>
      <button class="navbtn" id="navEmpty"><span class="navicon">üîÅ</span> Empty Spools</button>
    </div>

    <!-- INVENTORY PAGE -->
    <section id="pageInventory">
      <div class="pageHeader">
        <h1>Filament Inventory</h1>
        <div class="sub">Compact tiles (grouped) ‚Ä¢ click to manage ‚Ä¢ clearer low-stock signals</div>
      </div>

      <section class="kpis" id="kpis"></section>

      <section class="strip" id="lowStrip" style="display:none;">
        <div class="left">
          <span class="pill warn" id="lowStripPill">Low Stock</span>
          <div id="lowStripText" style="color:var(--text);font-weight:900;"></div>
        </div>
        <div class="row">
          <button class="btn" id="btnFilterLow">Show Low</button>
          <button class="btn" id="btnClearFilter">Clear Filter</button>
        </div>
      </section>

      <div class="controls">
        <input class="input" id="search" placeholder="Search (brand, color, type, finish)..." />
        <select id="typeFilter">
          <option value="all">All Types</option>
          <option value="PLA">PLA</option>
          <option value="ASA">ASA</option>
          <option value="PETG">PETG</option>
          <option value="ABS">ABS</option>
        </select>
        <select id="sort">
          <option value="newest">Newest First</option>
          <option value="remainingAsc">Lowest Remaining</option>
          <option value="remainingDesc">Highest Remaining</option>
          <option value="nameAsc">Name A‚ÜíZ</option>
        </select>
        <div class="spacer"></div>
        <span class="pill" id="countPill">0 items</span>
      </div>

      <section class="grid" id="grid"></section>
    </section>

    <!-- ADD FILAMENT PAGE -->
    <section id="pageAdd" style="display:none;">
      <div class="pageHeader">
        <h1>Add New Filament</h1>
        <div class="sub">Mocked to match your form layout</div>
      </div>

      <div class="formCard">
        <div class="formGrid">
          <div>
            <label class="req">Brand</label>
            <select id="addBrand">
              <option value="">Select Brand...</option>
              <option>Bambu Lab</option>
              <option>Prusament</option>
              <option>Polymaker</option>
              <option>Overture</option>
            </select>
          </div>

          <div>
            <label class="req">Type</label>
            <select id="addType">
              <option value="">Select...</option>
              <option>PLA</option><option>ASA</option><option>PETG</option><option>ABS</option>
            </select>
          </div>

          <div>
            <label>Finish/Variant</label>
            <select id="addFinish">
              <option>Standard</option>
              <option>Matte</option>
              <option>Silk</option>
              <option>CF</option>
              <option>Translucent</option>
            </select>
          </div>

          <div>
            <label class="req">Color Name</label>
            <input class="input" id="addName" placeholder="e.g., Jeans Blue" />
          </div>

          <div class="colSpan2">
            <label>Color Code</label>
            <div class="colorRow">
              <input class="input" id="addHex" value="#000000" />
              <div class="colorPreview" id="addHexPreview" title="Color preview"></div>
            </div>
          </div>

          <div>
            <label class="req">Total Weight (g)</label>
            <input class="input" id="addCapacity" type="number" min="1" step="1" value="1000" />
          </div>

          <div>
            <label class="req">Weight Remaining (g)</label>
            <input class="input" id="addRemaining" type="number" min="0" step="1" value="1000" />
          </div>

          <div>
            <label class="req">Quantity</label>
            <input class="input" id="addQty" type="number" min="1" step="1" value="1" />
          </div>

          <div>
            <label class="req">Type</label>
            <select id="addSpoolKind">
              <option>With Spool</option>
              <option>Refill</option>
            </select>
          </div>

          <div>
            <label>Spool Material</label>
            <select id="addSpoolMaterial">
              <option>Plastic</option>
              <option>Cardboard</option>
              <option>Reusable (Bambu/3rd party)</option>
            </select>
          </div>

          <div>
            <label>&nbsp;</label>
            <div class="checkRow">
              <input type="checkbox" id="addReusable" />
              <span>Reusable Spool</span>
            </div>
          </div>

          <div>
            <label>Diameter (mm)</label>
            <select id="addDiameter">
              <option>1.75mm</option>
              <option>2.85mm</option>
            </select>
          </div>

          <div class="colSpan2">
            <label>Storage Location</label>
            <input class="input" id="addLocation" placeholder="e.g., Shelf A, Box 1" />
          </div>

          <div class="colSpan4">
            <label>Notes</label>
            <textarea id="addNotes" placeholder="Additional information..."></textarea>
          </div>
        </div>

        <div class="formFooter">
          <button class="btn primary" id="btnAddSubmit">Add Filament</button>
          <button class="btn" id="btnAddCancel">Cancel</button>
        </div>
      </div>
    </section>

    <!-- EMPTY SPOOLS PAGE (placeholder) -->
    <section id="pageEmpty" style="display:none;">
      <div class="pageHeader">
        <h1>Empty Spools</h1>
        <div class="sub">Mock placeholder ‚Äî we can wire this to track empties and reusable spools.</div>
      </div>

      <div class="formCard" style="color:var(--muted);">
        This page can show:
        <ul>
          <li>Count of reusable spools available</li>
          <li>Which refills are waiting for a spool</li>
          <li>History of emptied spools</li>
        </ul>
      </div>
    </section>
  </div>

  <!-- MODAL -->
  <div class="backdrop" id="backdrop" role="dialog" aria-modal="true">
    <div class="modal" id="modal">
      <div class="modalHeader">
        <div class="modalTitle">
          <div class="modalSwatch" id="modalSwatch"></div>
          <div>
            <h2 id="modalTitle">Filament</h2>
            <div class="sub" id="modalSub">Brand ‚Ä¢ Type ‚Ä¢ Finish</div>
          </div>
        </div>
        <button class="iconBtn" id="btnClose" aria-label="Close">‚úï</button>
      </div>

      <div class="modalBody">
        <div class="twoCol">
          <div class="panel">
            <div class="panelTitle">Spools in this color</div>
            <div class="help" id="groupHelp"></div>

            <div class="spoolList" id="spoolList"></div>
          </div>

          <div class="panel">
            <div class="panelTitle">Edit selected spool</div>
            <div class="help">Pick a spool on the left, then edit or record usage here.</div>

            <div class="row" style="margin-top:10px;">
              <div class="field">
                <label>Spool kind</label>
                <select id="editSpoolKind">
                  <option>With Spool</option>
                  <option>Refill</option>
                </select>
              </div>
              <div class="field">
                <label>Reusable spool</label>
                <select id="editReusable">
                  <option value="false">No</option>
                  <option value="true">Yes</option>
                </select>
              </div>
            </div>

            <div class="row" style="margin-top:10px;">
              <div class="field">
                <label>Remaining (g)</label>
                <input class="input" id="editRemaining" type="number" min="0" step="1" />
              </div>
              <div class="field">
                <label>Capacity (g)</label>
                <input class="input" id="editCapacity" type="number" min="1" step="1" />
              </div>
            </div>

            <div class="row" style="margin-top:10px;">
              <div class="field">
                <label>Subtract (grams)</label>
                <input class="input" id="useGrams" type="number" min="0" step="1" value="50" />
              </div>
              <button class="btn primary" id="btnUse">Record</button>
            </div>

            <div class="row" style="margin-top:10px;">
              <button class="btn" id="btnUse25">-25</button>
              <button class="btn" id="btnUse50">-50</button>
              <button class="btn" id="btnUse100">-100</button>
            </div>

            <div class="help" id="useHelp"></div>

            <hr style="border:none;border-top:1px solid rgba(255,255,255,.10);margin:14px 0;">

            <div class="row">
              <div class="field">
                <label>Storage location</label>
                <input class="input" id="editLocation" />
              </div>
              <div class="field">
                <label>Notes</label>
                <input class="input" id="editNotes" />
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="modalFooter">
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
          <button class="btn primary" id="btnSave">Save</button>
          <button class="btn" id="btnCancel">Cancel</button>
        </div>
        <button class="btn danger" id="btnDelete">Delete selected spool</button>
      </div>
    </div>
  </div>

<script>
  // --- Low stock thresholds (tweak) ---
  const LOW_PCT = 0.25;
  const CRIT_PCT = 0.12;
  const LOW_G = 250;
  const CRIT_G = 120;

  // Unique colors per filament type
  const TYPE_COLORS = {
    PLA:  { bg:"rgba(34,197,94,.16)",  border:"rgba(34,197,94,.45)" },    // green
    PETG: { bg:"rgba(14,165,233,.16)", border:"rgba(14,165,233,.45)" },   // sky
    ASA:  { bg:"rgba(168,85,247,.16)", border:"rgba(168,85,247,.45)" },   // purple
    ABS:  { bg:"rgba(245,158,11,.16)", border:"rgba(245,158,11,.45)" },   // amber
    TPU:  { bg:"rgba(244,63,94,.16)",  border:"rgba(244,63,94,.45)" },    // rose
    NYLON:{ bg:"rgba(148,163,184,.16)",border:"rgba(148,163,184,.45)" }   // slate
  };

  // Unique colors per finish/variant
  const FINISH_COLORS = {
    Standard:{ bg:"rgba(148,163,184,.14)", border:"rgba(148,163,184,.40)" },
    Matte:   { bg:"rgba(100,116,139,.16)", border:"rgba(100,116,139,.45)" },
    Silk:    { bg:"rgba(245,158,11,.16)",  border:"rgba(245,158,11,.45)" },
    CF:      { bg:"rgba(17,24,39,.26)",    border:"rgba(255,255,255,.18)" },
    Gradient:{ bg:"rgba(59,130,246,.16)",  border:"rgba(59,130,246,.45)" },
    Translucent:{ bg:"rgba(20,184,166,.16)", border:"rgba(20,184,166,.45)" }
  };

  function typeStyle(type){
    return TYPE_COLORS[type] || { bg:"rgba(16,185,129,.12)", border:"rgba(16,185,129,.35)" };
  }
  function finishStyle(finish){
    return FINISH_COLORS[finish] || { bg:"rgba(59,130,246,.12)", border:"rgba(59,130,246,.35)" };
  }

  // Supports hex OR CSS gradients
  function swatchCss(value){
    const v = (value || "#64748b").trim();
    const isGradient =
      v.startsWith("linear-gradient") ||
      v.startsWith("radial-gradient") ||
      v.startsWith("conic-gradient");
    // If it's not a gradient, it's expected to be a CSS color (hex, rgb(), etc.)
    return isGradient ? v : v;
  }

  // Demo dataset with per-spool instances
  // NOTE: "hex" now supports hex OR gradient strings
  let spools = [
    { id:1, brand:"Bambu Lab", name:"Charcoal", type:"PLA", finish:"Matte", hex:"#121212", capacity:1000, remaining:1000, spoolKind:"With Spool", reusableSpool:false, diameter:"1.75mm", spoolMaterial:"Plastic", location:"Shelf A", notes:"", createdAt: 1700000000 },
    { id:2, brand:"Bambu Lab", name:"Lava Gray", type:"PLA", finish:"CF", hex:"#6b7280", capacity:1000, remaining:1000, spoolKind:"Refill", reusableSpool:true, diameter:"1.75mm", spoolMaterial:"Reusable", location:"Box 2", notes:"Needs reusable spool", createdAt: 1700000100 },
    { id:3, brand:"Bambu Lab", name:"Jeans Blue", type:"PLA", finish:"CF", hex:"#6ea8ff", capacity:1000, remaining:1000, spoolKind:"With Spool", reusableSpool:true, diameter:"1.75mm", spoolMaterial:"Reusable", location:"Shelf B", notes:"", createdAt: 1700000200 },
    { id:4, brand:"Bambu Lab", name:"Jeans Blue", type:"PLA", finish:"CF", hex:"#6ea8ff", capacity:1000, remaining:820, spoolKind:"Refill", reusableSpool:true, diameter:"1.75mm", spoolMaterial:"Reusable", location:"Shelf B", notes:"Backup refill", createdAt: 1700000210 },
    { id:5, brand:"Bambu Lab", name:"Burgundy Red", type:"PLA", finish:"CF", hex:"#7f1d1d", capacity:1000, remaining:1000, spoolKind:"With Spool", reusableSpool:false, diameter:"1.75mm", spoolMaterial:"Plastic", location:"Shelf A", notes:"", createdAt: 1700000300 },
    { id:6, brand:"Bambu Lab", name:"Gray", type:"ASA", finish:"Standard", hex:"#9ca3af", capacity:1000, remaining:1000, spoolKind:"With Spool", reusableSpool:false, diameter:"1.75mm", spoolMaterial:"Plastic", location:"Shelf C", notes:"", createdAt: 1700000400 },
    { id:7, brand:"Bambu Lab", name:"Gold", type:"PLA", finish:"Silk", hex:"#f59e0b", capacity:1000, remaining:766, spoolKind:"With Spool", reusableSpool:false, diameter:"1.75mm", spoolMaterial:"Plastic", location:"Shelf D", notes:"", createdAt: 1700000500 },
    { id:8, brand:"Bambu Lab", name:"White", type:"PLA", finish:"Matte", hex:"#e5e7eb", capacity:1000, remaining:180, spoolKind:"With Spool", reusableSpool:false, diameter:"1.75mm", spoolMaterial:"Plastic", location:"Shelf A", notes:"Low", createdAt: 1700000600 },
    { id:9, brand:"Bambu Lab", name:"Forest Green", type:"PLA", finish:"Matte", hex:"#14532d", capacity:1000, remaining:90, spoolKind:"Refill", reusableSpool:true, diameter:"1.75mm", spoolMaterial:"Reusable", location:"Box 1", notes:"Critical", createdAt: 1700000700 },

    /* Example gradient spool (uncomment to test)
    { id:10, brand:"Bambu Lab", name:"Sunset Gradient", type:"PLA", finish:"Gradient",
      hex:"linear-gradient(90deg,#fb7185,#f59e0b,#22c55e,#60a5fa)",
      capacity:1000, remaining:620, spoolKind:"With Spool", reusableSpool:false, diameter:"1.75mm", spoolMaterial:"Plastic", location:"Shelf G", notes:"", createdAt: 1700000800 },
    */
  ];

  // Inventory tiles are GROUPS
  // groupKey: brand|name|type|finish|hex
  function groupKey(s){
    return [s.brand, s.name, s.type, s.finish, (s.hex||"").toLowerCase()].join("|");
  }

  const el = (id) => document.getElementById(id);
  const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));

  let filterLowOnly = false;
  let selectedGroup = null;   // group key
  let selectedSpoolId = null; // individual spool id

  // --- Navigation ---
  function setPage(page){
    const pages = ["Inventory","Add","Empty"];
    pages.forEach(p=>{
      el("page"+p).style.display = (p===page) ? "" : "none";
      el("nav"+p).classList.toggle("active", p===page);
    });
  }
  el("navInventory").addEventListener("click", ()=>setPage("Inventory"));
  el("navAdd").addEventListener("click", ()=>setPage("Add"));
  el("navEmpty").addEventListener("click", ()=>setPage("Empty"));

  // --- Status ---
  function computeStatus(s){
    const pct = s.capacity ? (s.remaining / s.capacity) : 0;
    const critical = (pct <= CRIT_PCT) || (s.remaining <= CRIT_G);
    const low = !critical && ((pct <= LOW_PCT) || (s.remaining <= LOW_G));
    return { pct, low, critical };
  }

  function computeGroupStatus(groupSpools){
    // group is low/critical if ANY spool in group is low/critical
    let anyCrit = false, anyLow = false;
    let totalRemaining = 0, totalCapacity = 0;

    for (const s of groupSpools){
      const st = computeStatus(s);
      anyCrit = anyCrit || st.critical;
      anyLow = anyLow || st.low;
      totalRemaining += (s.remaining||0);
      totalCapacity += (s.capacity||0);
    }

    const pct = totalCapacity ? (totalRemaining/totalCapacity) : 0;
    return { pct, low: anyLow, critical: anyCrit, totalRemaining, totalCapacity };
  }

  // --- Render KPIs ---
  function renderKPIs(){
    const totalSpools = spools.reduce((a)=>a+1,0);
    const reusableInUse = spools.filter(s => s.reusableSpool && s.spoolKind === "With Spool").length;
    const refills = spools.filter(s => s.spoolKind === "Refill").length;

    const kpis = [
      { label:"Total Spools", value: totalSpools },
      { label:"Reusable In Use", value: reusableInUse },
      { label:"Refill Cartridges", value: refills }
    ];

    el("kpis").innerHTML = kpis.map(k => `
      <div class="kpi">
        <div class="label">${k.label}</div>
        <div class="value">${k.value}</div>
      </div>
    `).join("");
  }

  // --- Filtering/sorting for GROUPS ---
  function getGroups(){
    const map = new Map();
    for (const s of spools){
      const k = groupKey(s);
      if (!map.has(k)) map.set(k, []);
      map.get(k).push(s);
    }
    return Array.from(map.entries()).map(([key, items]) => ({ key, items }));
  }

  function applyFilters(groups){
    const q = el("search").value.trim().toLowerCase();
    const tf = el("typeFilter").value;

    let out = groups.slice();

    if (q){
      out = out.filter(g => {
        const one = g.items[0];
        return (
          (one.brand||"").toLowerCase().includes(q) ||
          (one.name||"").toLowerCase().includes(q) ||
          (one.type||"").toLowerCase().includes(q) ||
          (one.finish||"").toLowerCase().includes(q)
        );
      });
    }
    if (tf !== "all"){
      out = out.filter(g => g.items[0].type === tf);
    }
    if (filterLowOnly){
      out = out.filter(g => {
        const gs = computeGroupStatus(g.items);
        return gs.low || gs.critical;
      });
    }
    return out;
  }

  function applySort(groups){
    const s = el("sort").value;
    const out = groups.slice();

    if (s === "newest"){
      out.sort((a,b)=>{
        const ma = Math.max(...a.items.map(x=>x.createdAt||0));
        const mb = Math.max(...b.items.map(x=>x.createdAt||0));
        return mb - ma;
      });
    }
    if (s === "remainingAsc"){
      out.sort((a,b)=> computeGroupStatus(a.items).pct - computeGroupStatus(b.items).pct);
    }
    if (s === "remainingDesc"){
      out.sort((a,b)=> computeGroupStatus(b.items).pct - computeGroupStatus(a.items).pct);
    }
    if (s === "nameAsc"){
      out.sort((a,b)=> (a.items[0].name||"").localeCompare(b.items[0].name||""));
    }
    return out;
  }

  function renderLowStrip(){
    const lowGroups = getGroups().filter(g=>{
      const gs = computeGroupStatus(g.items);
      return gs.low || gs.critical;
    });
    const critGroups = lowGroups.filter(g => computeGroupStatus(g.items).critical);

    if (lowGroups.length === 0){
      el("lowStrip").style.display = "none";
      return;
    }
    el("lowStrip").style.display = "flex";

    el("lowStripText").textContent =
      `${lowGroups.length} color(s) low ‚Äî ${critGroups.length} critical`;

    const pill = el("lowStripPill");
    pill.classList.remove("warn","danger");
    if (critGroups.length){
      pill.classList.add("danger");
      pill.textContent = "Critical Stock";
    } else {
      pill.classList.add("warn");
      pill.textContent = "Low Stock";
    }
  }

  function escapeHtml(str){
    return String(str ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function tileHTML(group){
    const one = group.items[0];
    const gs = computeGroupStatus(group.items);

    const pctInt = Math.round(gs.pct*100);

    // status class always present
    let statusClass = "ok";
    if (gs.low) statusClass = "low";
    if (gs.critical) statusClass = "critical";

    const tileClass = `tile ${statusClass}`;
    const stackedClass = group.items.length > 1 ? " stacked" : "";

    const badgeText = gs.critical ? "CRITICAL" : (gs.low ? "LOW" : "OK");
    const badgeIcon = gs.critical ? "‚õî" : (gs.low ? "‚ö†Ô∏è" : "‚úÖ");

    const barClass = (gs.low || gs.critical) ? "bar low" : "bar";

    const readyCount = group.items.filter(s=>s.spoolKind==="With Spool").length;
    const refillCount = group.items.filter(s=>s.spoolKind==="Refill").length;

    // Chip colors via CSS variables
    const t = typeStyle(one.type);
    const f = finishStyle(one.finish);

    // Swatch (hex OR gradient)
    const sw = swatchCss(one.hex);

    return `
      <div class="${tileClass}${stackedClass}"
           tabindex="0" role="button"
           style="
             --swatch:${sw};
             --typeBg:${t.bg}; --typeBorder:${t.border};
             --finishBg:${f.bg}; --finishBorder:${f.border};
           "
           data-gkey="${escapeHtml(group.key)}">
        <div class="swatch">
          <div class="badge">${badgeIcon}<span>${badgeText}</span></div>
        </div>

        <div class="stackBadge">${group.items.length}√ó</div>

        <div class="tileBody">
          <div class="brand">${escapeHtml(one.brand)}</div>

          <div class="nameRow">
            <div class="name">${escapeHtml(one.name)}</div>
            <div class="pct">${pctInt}%</div>
          </div>

          <div class="meta">
            <span class="tag type" style="--typeBg:${t.bg};--typeBorder:${t.border}">${escapeHtml(one.type)}</span>
            <span class="tag finish" style="--finishBg:${f.bg};--finishBorder:${f.border}">${escapeHtml(one.finish)}</span>
            ${readyCount ? `<span class="tag ready">Ready: ${readyCount}</span>` : ""}
            ${refillCount ? `<span class="tag refill">Refill: ${refillCount}</span>` : ""}
          </div>

          <div class="barWrap" title="${gs.totalRemaining}g / ${gs.totalCapacity}g (group total)">
            <div class="${barClass}" style="--pct:${clamp(pctInt,0,100)}%"></div>
          </div>

          <div class="tileFooter">
            <span>${gs.totalRemaining}g / ${gs.totalCapacity}g</span>
            <span>${group.items.length > 1 ? "Multiple spools" : "Single spool"}</span>
          </div>
        </div>
      </div>
    `;
  }

  function renderGrid(){
    const groups = getGroups();
    const filtered = applyFilters(groups);
    const sorted = applySort(filtered);

    el("countPill").textContent = `${sorted.length} color(s)`;

    el("grid").innerHTML = sorted.map(tileHTML).join("");

    el("grid").querySelectorAll(".tile").forEach(t=>{
      t.addEventListener("click", ()=> openModal(t.dataset.gkey));
      t.addEventListener("keydown", (e)=>{
        if (e.key==="Enter" || e.key===" ") openModal(t.dataset.gkey);
      });
    });
  }

  // --- Modal ---
  function openModal(groupKeyStr){
    selectedGroup = groupKeyStr;
    const group = getGroups().find(g => g.key === groupKeyStr);
    if (!group) return;

    const one = group.items[0];
    const sw = swatchCss(one.hex);

    // modal uses same swatch (supports gradients)
    el("modalSwatch").style.background = sw;
    el("modalTitle").textContent = `${one.name}`;
    el("modalSub").textContent = `${one.brand} ‚Ä¢ ${one.type} ‚Ä¢ ${one.finish}`;

    // Fill left list
    const ready = group.items.filter(s=>s.spoolKind==="With Spool");
    const refill = group.items.filter(s=>s.spoolKind==="Refill");
    el("groupHelp").textContent =
      `${group.items.length} spool(s) total ‚Äî Ready: ${ready.length}, Refill: ${refill.length}`;

    el("spoolList").innerHTML = group.items
      .sort((a,b)=>(b.remaining/b.capacity)-(a.remaining/a.capacity))
      .map(s=>{
        const st = computeStatus(s);
        const pct = Math.round(st.pct*100);
        const status = st.critical ? "CRITICAL" : (st.low ? "LOW" : "OK");
        const icon = st.critical ? "‚õî" : (st.low ? "‚ö†Ô∏è" : "‚úÖ");
        return `
          <div class="spoolRow" data-sid="${s.id}" style="--swatch:${sw}">
            <div class="left">
              <div class="miniSwatch"></div>
              <div style="min-width:0;">
                <div class="title">${icon} #${s.id} ‚Ä¢ ${escapeHtml(s.spoolKind)} ‚Ä¢ ${pct}%</div>
                <div class="subline">${s.remaining}g / ${s.capacity}g ‚Ä¢ ${status}${s.reusableSpool ? " ‚Ä¢ Reusable" : ""}</div>
              </div>
            </div>
            <div class="right">
              <button class="tinyBtn" data-action="select">Select</button>
              <button class="tinyBtn primary" data-action="use25">-25</button>
            </div>
          </div>
        `;
      }).join("");

    // Hook list buttons
    el("spoolList").querySelectorAll(".spoolRow").forEach(row=>{
      row.addEventListener("click", (e)=>{
        const sid = Number(row.dataset.sid);
        const action = e.target?.dataset?.action;
        if (action === "use25"){
          selectSpool(sid);
          recordUsage(25);
          return;
        }
        selectSpool(sid);
      });
      row.querySelectorAll("button").forEach(btn=>{
        btn.addEventListener("click",(e)=>e.stopPropagation());
      });
      const selBtn = row.querySelector('[data-action="select"]');
      if (selBtn) selBtn.addEventListener("click", ()=>{
        selectSpool(Number(row.dataset.sid));
      });
    });

    selectSpool(group.items[0].id);
    el("backdrop").classList.add("show");
  }

  function closeModal(){
    el("backdrop").classList.remove("show");
    selectedGroup = null;
    selectedSpoolId = null;
  }

  function selectSpool(id){
    selectedSpoolId = id;
    const s = spools.find(x=>x.id===id);
    if (!s) return;

    el("spoolList").querySelectorAll(".spoolRow").forEach(r=>{
      r.style.outline = (Number(r.dataset.sid)===id) ? "2px solid rgba(59,130,246,.55)" : "none";
      r.style.boxShadow = (Number(r.dataset.sid)===id) ? "0 0 0 3px rgba(59,130,246,.18)" : "none";
    });

    // Populate editor
    el("editSpoolKind").value = s.spoolKind;
    el("editReusable").value = String(!!s.reusableSpool);
    el("editRemaining").value = s.remaining;
    el("editCapacity").value = s.capacity;
    el("editLocation").value = s.location || "";
    el("editNotes").value = s.notes || "";

    const st = computeStatus(s);
    const pct = Math.round(st.pct*100);
    const status = st.critical ? "CRITICAL" : (st.low ? "LOW" : "OK");
    el("useHelp").textContent = `Selected spool #${s.id} ‚Äî ${s.remaining}g (${pct}%) ‚Äî ${status}`;
  }

  function recordUsage(grams){
    const s = spools.find(x=>x.id===selectedSpoolId);
    if (!s) return;
    const g = clamp(Number(grams)||0, 0, 100000);
    s.remaining = clamp(s.remaining - g, 0, s.capacity);
    el("editRemaining").value = s.remaining;

    // refresh UI
    renderKPIs();
    renderLowStrip();
    renderGrid();
    // refresh modal group list (keep modal open)
    openModal(selectedGroup);
  }

  function saveEdits(){
    const s = spools.find(x=>x.id===selectedSpoolId);
    if (!s) return;

    s.spoolKind = el("editSpoolKind").value;
    s.reusableSpool = (el("editReusable").value === "true");
    s.capacity = clamp(Number(el("editCapacity").value)||s.capacity, 1, 50000);
    s.remaining = clamp(Number(el("editRemaining").value)||s.remaining, 0, s.capacity);
    s.location = el("editLocation").value.trim();
    s.notes = el("editNotes").value.trim();

    renderKPIs();
    renderLowStrip();
    renderGrid();
    closeModal();
  }

  function deleteSelected(){
    if (selectedSpoolId == null) return;
    spools = spools.filter(s => s.id !== selectedSpoolId);
    renderKPIs();
    renderLowStrip();
    renderGrid();
    closeModal();
  }

  // --- Wire controls ---
  ["search","typeFilter","sort"].forEach(id => el(id).addEventListener("input", () => renderGrid()));
  el("btnFilterLow").addEventListener("click", () => { filterLowOnly = true; renderGrid(); });
  el("btnClearFilter").addEventListener("click", () => { filterLowOnly = false; renderGrid(); });

  el("btnClose").addEventListener("click", closeModal);
  el("btnCancel").addEventListener("click", closeModal);
  el("backdrop").addEventListener("click", (e) => { if (e.target === el("backdrop")) closeModal(); });

  el("btnUse").addEventListener("click", () => recordUsage(el("useGrams").value));
  el("btnUse25").addEventListener("click", () => recordUsage(25));
  el("btnUse50").addEventListener("click", () => recordUsage(50));
  el("btnUse100").addEventListener("click", () => recordUsage(100));

  el("btnSave").addEventListener("click", saveEdits);
  el("btnDelete").addEventListener("click", deleteSelected);

  // --- Add Filament page ---
  function setHexPreview(){
    const v = (el("addHex").value || "#000000").trim();
    // support gradient strings as well
    el("addHexPreview").style.background = v;
  }
  el("addHex").addEventListener("input", setHexPreview);
  setHexPreview();

  function addFilamentSubmit(){
    const brand = el("addBrand").value.trim();
    const type = el("addType").value.trim();
    const finish = el("addFinish").value.trim();
    const name = el("addName").value.trim();
    const hex = (el("addHex").value.trim() || "#000000");
    const capacity = clamp(Number(el("addCapacity").value)||1000, 1, 50000);
    const remaining = clamp(Number(el("addRemaining").value)||capacity, 0, capacity);
    const qty = clamp(Number(el("addQty").value)||1, 1, 100);
    const spoolKind = el("addSpoolKind").value;
    const spoolMaterial = el("addSpoolMaterial").value;
    const reusable = el("addReusable").checked;
    const diameter = el("addDiameter").value;
    const location = el("addLocation").value.trim();
    const notes = el("addNotes").value.trim();

    if (!brand || !type || !name){
      alert("Please fill Brand, Type, and Color Name.");
      return;
    }

    let nextId = Math.max(0, ...spools.map(s=>s.id)) + 1;
    const now = Math.floor(Date.now()/1000);

    for (let i=0;i<qty;i++){
      spools.push({
        id: nextId++,
        brand, type, finish, name, hex,
        capacity, remaining,
        spoolKind,
        spoolMaterial,
        reusableSpool: reusable,
        diameter,
        location,
        notes,
        createdAt: now + i
      });
    }

    // Refresh and return to inventory
    renderKPIs(); renderLowStrip(); renderGrid();
    setPage("Inventory");
  }

  el("btnAddSubmit").addEventListener("click", addFilamentSubmit);
  el("btnAddCancel").addEventListener("click", ()=> setPage("Inventory"));

  // --- Initial render ---
  renderKPIs();
  renderLowStrip();
  renderGrid();
</script>
</body>
</html>
