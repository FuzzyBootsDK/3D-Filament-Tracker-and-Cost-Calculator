@using FilamentTracker.Models
@using FilamentTracker.Services
@inject FilamentService FilamentService
@inject ThresholdService ThresholdService

@if (Filament != null)
{
    <div class="backdrop show" @onclick="HandleBackdropClick">
        <div class="modal" @onclick:stopPropagation="true">
            <div class="modalHeader">
                <div class="modalTitle">
                    <div class="modalSwatch" style="background: @Filament.ColorCode;"></div>
                    <div>
                        <h2>@Filament.Brand @Filament.ColorName</h2>
                        <div class="sub">@Filament.Type@(!string.IsNullOrEmpty(Filament.Finish) ? $" ‚Ä¢ {Filament.Finish}" : "")</div>
                    </div>
                </div>
                <button class="iconBtn" @onclick="Close" aria-label="Close">‚úï</button>
            </div>

            <div class="modalBody">
                <div class="twoCol">
                    <!-- Left: Spool list -->
                    <div class="panel">
                        <div class="panelTitle">Spools (@Filament.SpoolCount)</div>
                        <div class="help">
                            Total: @Math.Round(Filament.WeightRemaining, 0)g / @Math.Round(Filament.TotalWeight, 0)g 
                            (@Math.Round(Filament.PercentRemaining, 0)%)
                        </div>

                        <div class="spoolList">
                            @{
                                // Order spools: partially used first, then oldest first
                                var orderedSpools = Filament.Spools
                                    .Where(s => s.WeightRemaining > 0 && !s.DateEmptied.HasValue)
                                    .OrderBy(s => s.PercentRemaining == 100 ? 1 : 0)
                                    .ThenBy(s => s.DateAdded)
                                    .ToList();
                                    
                                var emptySpools = Filament.Spools
                                    .Where(s => s.WeightRemaining <= 0 || s.DateEmptied.HasValue)
                                    .OrderByDescending(s => s.DateEmptied ?? s.DateAdded)
                                    .ToList();
                                    
                                var allSpools = orderedSpools.Concat(emptySpools).ToList();
                                var nextSpoolId = orderedSpools.FirstOrDefault()?.Id;
                            }
                            
                            @foreach (var spool in allSpools)
                            {
                                var isNextToUse = spool.Id == nextSpoolId && spool.WeightRemaining > 0;
                                
                                <div class="spoolRow @(selectedSpool?.Id == spool.Id ? "selected" : "")" 
                                     @onclick="() => SelectSpool(spool)"
                                     style="@(isNextToUse ? "border-left: 3px solid var(--ok);" : "")">
                                    <div class="left">
                                        <div class="miniSwatch" style="background: @Filament.ColorCode;"></div>
                                        <div style="min-width: 0;">
                                            <div class="title">
                                                @if (isNextToUse)
                                                {
                                                    <span style="color: var(--ok); font-weight: 900;">‚ñ∂ </span>
                                                }
                                                @(spool.IsRefill ? "Refill" : "On Spool") 
                                                - @Math.Round(spool.WeightRemaining, 0)g
                                            </div>
                                            <div class="subline">
                                                @Math.Round(spool.PercentRemaining, 0)% ‚Ä¢ 
                                                @(spool.SpoolMaterial ?? "none")
                                                @(spool.IsReusable ? " ‚Ä¢ Reusable" : "")
                                                @if (isNextToUse)
                                                {
                                                    <span style="color: var(--ok); font-weight: 700;"> ‚Ä¢ Next to use</span>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                    <div class="right">
                                        <span class="pill @GetSpoolStatus(spool)">
                                            @GetSpoolStatusText(spool)
                                        </span>
                                    </div>
                                </div>
                            }
                        </div>
                        
                        <button class="btn" style="margin-top: 12px; width: 100%;" @onclick="ToggleAddSpool">
                            @(showAddSpool ? "‚ùå Cancel" : "‚ûï Add New Spool")
                        </button>
                        
                        @if (showAddSpool)
                        {
                            <div style="margin-top: 12px; padding: 12px; border: 1px solid var(--border); border-radius: 12px; background: rgba(59, 130, 246, .08);">
                                <div style="margin-bottom: 10px;">
                                    <label>Spool Type</label>
                                    <select class="input" value="@(newSpoolIsRefill ? "true" : "false")" @onchange="OnNewSpoolTypeChanged">
                                        <option value="false">On Spool</option>
                                        <option value="true">Refill</option>
                                    </select>
                                </div>
                                
                                <div style="margin-bottom: 10px;">
                                    <label>Total Weight (g)</label>
                                    <input class="input" type="number" @bind="newSpoolTotalWeight" min="1" step="1" />
                                </div>
                                
                                <div style="margin-bottom: 10px;">
                                    <label>Weight Remaining (g)</label>
                                    <input class="input" type="number" @bind="newSpoolWeightRemaining" min="0" step="1" />
                                </div>
                                
                                <div style="margin-bottom: 10px;">
                                    <label>Spool Material</label>
                                    <select class="input" @bind="newSpoolMaterial">
                                        <option value="">None</option>
                                        <option value="plastic">Plastic</option>
                                        <option value="cardboard">Cardboard</option>
                                    </select>
                                </div>
                                
                                <div style="margin-bottom: 10px;">
                                    <label>Purchase Price Per Kg (optional)</label>
                                    <input class="input" type="number" @bind="newSpoolPurchasePrice" step="0.01" min="0" placeholder="e.g., 149.00" />
                                    <small style="color: var(--muted); font-size: 11px; margin-top: 4px; display: block;">
                                        Updates weighted average for calculator
                                    </small>
                                </div>
                                
                                <div style="margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" @bind="newSpoolIsReusable" id="newSpoolReusableCheck" />
                                    <label for="newSpoolReusableCheck" style="margin: 0; cursor: pointer;">Reusable Spool</label>
                                </div>
                                
                                <button class="btn primary" style="width: 100%;" @onclick="AddNewSpool">
                                    Add Spool
                                </button>
                            </div>
                        }
                    </div>

                    <!-- Right: Edit panel -->
                    <div class="panel">
                        <div class="panelTitle">Manage Spool</div>
                        
                        @if (selectedSpool == null)
                        {
                            <div class="help">Select a spool on the left to manage it.</div>
                        }
                        else
                        {
                            <div class="help">Editing: @(selectedSpool.IsRefill ? "Refill" : "Spool") (@Math.Round(selectedSpool.WeightRemaining, 0)g)</div>

                            <!-- Record usage -->
                            <div style="margin-top: 16px;">
                                <label>Record Usage</label>
                                <div class="row">
                                    <div class="field">
                                        <input class="input" type="number" @bind="gramsToSubtract" min="0" step="1" placeholder="Grams used" />
                                    </div>
                                    <button class="btn primary" @onclick="RecordUsage">Record</button>
                                </div>
                            </div>

                            <div class="row" style="margin-top: 8px;">
                                <button class="btn" @onclick="() => RecordUsageQuick(25)">-25g</button>
                                <button class="btn" @onclick="() => RecordUsageQuick(50)">-50g</button>
                                <button class="btn" @onclick="() => RecordUsageQuick(100)">-100g</button>
                            </div>

                            @if (!string.IsNullOrEmpty(usageMessage))
                            {
                                <div class="help" style="color: var(--ok); margin-top: 8px;">
                                    @usageMessage
                                </div>
                            }

                            <hr style="border: none; border-top: 1px solid rgba(255,255,255,.10); margin: 16px 0;" />

                            <!-- Edit spool details -->
                            <!-- Edit spool details -->
                            <div>
                                <label>Spool Type</label>
                                <select class="input" value="@(editIsRefill ? "true" : "false")" @onchange="OnEditSpoolTypeChanged">
                                    <option value="false">On Spool</option>
                                    <option value="true">Refill</option>
                                </select>
                            </div>

                            <div style="margin-top: 10px;">
                                <label>Remaining (g)</label>
                                <input class="input" type="number" @bind="editRemaining" min="0" step="1" />
                            </div>

                            <div style="margin-top: 10px;">
                                <label>Total Capacity (g)</label>
                                <input class="input" type="number" @bind="editCapacity" min="1" step="1" />
                            </div>

                            <div style="margin-top: 10px;">
                                <label>Spool Material</label>
                                <select class="input" @bind="editMaterial">
                                    <option value="">None</option>
                                    <option value="plastic">Plastic</option>
                                    <option value="cardboard">Cardboard</option>
                                </select>
                            </div>
                            
                            <div style="margin-top: 10px;">
                                <label>Purchase Price Per Kg (optional)</label>
                                <input class="input" type="number" @bind="editPurchasePrice" step="0.01" min="0" placeholder="e.g., 149.00" />
                                <small style="color: var(--muted); font-size: 11px; margin-top: 4px; display: block;">
                                    Used for weighted average in calculator
                                </small>
                            </div>

                            <div class="checkRow" style="margin-top: 12px;">
                                <input type="checkbox" @bind="editReusable" id="editReusableCheck" />
                                <label for="editReusableCheck" style="margin: 0; cursor: pointer;">Reusable Spool</label>
                            </div>
                        }
                    </div>
                </div>

                <!-- Filament-level info -->
                <div class="panel" style="margin-top: 14px;">
                    <div class="panelTitle">Filament Details</div>
                    
                    <div style="margin-bottom: 14px; padding: 10px; border-radius: 8px; background: rgba(59, 130, 246, .08);">
                        <div style="font-size: 13px; color: var(--muted); margin-bottom: 4px;">
                            üí∞ Calculated Average Price for Calculator
                        </div>
                        <div style="font-size: 18px; font-weight: 700;">
                            @Filament.CalculatedPricePerKg.ToString("F2") per kg
                        </div>
                        @{
                            var spoolsWithPrices = Filament.Spools.Where(s => s.PurchasePricePerKg.HasValue).ToList();
                            if (spoolsWithPrices.Any())
                            {
                                <div style="font-size: 11px; color: var(--muted); margin-top: 4px;">
                                    Average from @spoolsWithPrices.Count spool(s) with prices
                                </div>
                            }
                            else if (Filament.PricePerKg.HasValue)
                            {
                                <div style="font-size: 11px; color: var(--muted); margin-top: 4px;">
                                    Using manual override price
                                </div>
                            }
                            else
                            {
                                <div style="font-size: 11px; color: var(--muted); margin-top: 4px;">
                                    Default price (no spools have price set)
                                </div>
                            }
                        }
                    </div>
                    
                    <div style="margin-bottom: 10px;">
                        <label>Manual Price Override (optional)</label>
                        <input class="input" type="number" @bind="editManualPrice" step="0.01" min="0" placeholder="Leave empty to use spool average" />
                        <small style="color: var(--muted); font-size: 11px; margin-top: 4px; display: block;">
                            Set this to override automatic average calculation
                        </small>
                    </div>
                    
                    <div class="row">
                        <div class="field">
                            <label>Storage Location</label>
                            <input class="input" @bind="editLocation" />
                        </div>
                        <div class="field">
                            <label>Diameter (mm)</label>
                            <input class="input" type="number" @bind="editDiameter" step="0.01" />
                        </div>
                    </div>
                    <div style="margin-top: 10px;">
                        <label>Notes</label>
                        <textarea class="input" @bind="editNotes"></textarea>
                    </div>
                </div>
            </div>

            <div class="modalFooter">
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn primary" @onclick="SaveChanges">Save All Changes</button>
                    <button class="btn" @onclick="Close">Close</button>
                </div>
                @if (selectedSpool != null)
                {
                    <button class="btn danger" @onclick="DeleteSpool">Delete This Spool</button>
                }
                else
                {
                    <button class="btn danger" @onclick="DeleteFilament">Delete Entire Filament</button>
                }
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public Filament? Filament { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback OnUpdate { get; set; }

    private Spool? selectedSpool;
    private decimal gramsToSubtract = 50;
    private string usageMessage = "";

    // Edit fields
    private bool editIsRefill;
    private decimal editRemaining;
    private decimal editCapacity;
    private string? editMaterial;
    private bool editReusable;
    private decimal? editPurchasePrice;
    private string? editLocation;
    private string? editNotes;
    private decimal editDiameter;
    private decimal? editManualPrice;
    
    // Add new spool fields
    private bool showAddSpool = false;
    private bool newSpoolIsRefill = false;
    private decimal newSpoolTotalWeight = 1000;
    private decimal newSpoolWeightRemaining = 1000;
    private string? newSpoolMaterial = "";
    private bool newSpoolIsReusable = false;
    private decimal? newSpoolPurchasePrice;

    protected override void OnParametersSet()
    {
        if (Filament != null)
        {
            selectedSpool = Filament.Spools.FirstOrDefault();
            LoadSpoolForEditing();
            LoadFilamentForEditing();
        }
    }

    private void SelectSpool(Spool spool)
    {
        selectedSpool = spool;
        LoadSpoolForEditing();
        usageMessage = "";
    }

    private void LoadSpoolForEditing()
    {
        if (selectedSpool != null)
        {
            editIsRefill = selectedSpool.IsRefill;
            editRemaining = selectedSpool.WeightRemaining;
            editCapacity = selectedSpool.TotalWeight;
            editMaterial = selectedSpool.SpoolMaterial;
            editReusable = selectedSpool.IsReusable;
            editPurchasePrice = selectedSpool.PurchasePricePerKg;
        }
    }

    private void LoadFilamentForEditing()
    {
        if (Filament != null)
        {
            editLocation = Filament.Location;
            editNotes = Filament.Notes;
            editDiameter = Filament.Diameter;
            editManualPrice = Filament.PricePerKg;
        }
    }

    private async Task RecordUsage()
    {
        if (selectedSpool == null || gramsToSubtract <= 0) return;

        selectedSpool.WeightRemaining = Math.Max(0, selectedSpool.WeightRemaining - gramsToSubtract);
        editRemaining = selectedSpool.WeightRemaining;
        
        await FilamentService.UpdateSpoolAsync(selectedSpool);
        
        // Reload filament to ensure everything is in sync
        if (Filament != null)
        {
            var updated = await FilamentService.GetFilamentByIdAsync(Filament.Id);
            if (updated != null)
            {
                Filament = updated;
                selectedSpool = Filament.Spools.FirstOrDefault(s => s.Id == selectedSpool.Id);
                LoadSpoolForEditing();
            }
        }
        
        await OnUpdate.InvokeAsync();
        StateHasChanged();
        
        usageMessage = $"Recorded {gramsToSubtract}g usage. {Math.Round(selectedSpool?.WeightRemaining ?? 0, 0)}g remaining.";
        
        _ = Task.Delay(3000).ContinueWith(_ =>
        {
            usageMessage = "";
            InvokeAsync(StateHasChanged);
        });
    }

    private async Task RecordUsageQuick(decimal grams)
    {
        gramsToSubtract = grams;
        await RecordUsage();
    }

    private async Task SaveChanges()
    {
        if (Filament == null) return;

        // Update spool if selected
        if (selectedSpool != null)
        {
            selectedSpool.IsRefill = editIsRefill;
            selectedSpool.WeightRemaining = editRemaining;
            selectedSpool.TotalWeight = editCapacity;
            selectedSpool.SpoolMaterial = editMaterial;
            selectedSpool.IsReusable = editReusable;
            selectedSpool.PurchasePricePerKg = editPurchasePrice;
            
            await FilamentService.UpdateSpoolAsync(selectedSpool);
        }

        // Update filament
        Filament.Location = editLocation;
        Filament.Notes = editNotes;
        Filament.Diameter = editDiameter;
        Filament.PricePerKg = editManualPrice;
        
        await FilamentService.UpdateFilamentAsync(Filament);
        
        // Reload filament to get updated calculated price
        var updated = await FilamentService.GetFilamentByIdAsync(Filament.Id);
        if (updated != null)
        {
            Filament = updated;
            // Reselect the current spool if it still exists
            if (selectedSpool != null)
            {
                selectedSpool = Filament.Spools.FirstOrDefault(s => s.Id == selectedSpool.Id);
                LoadSpoolForEditing();
            }
            LoadFilamentForEditing();
        }
        
        await OnUpdate.InvokeAsync();
        StateHasChanged();
        
        usageMessage = "Changes saved successfully!";
        _ = Task.Delay(2000).ContinueWith(_ =>
        {
            usageMessage = "";
            InvokeAsync(StateHasChanged);
        });
    }

    private async Task DeleteSpool()
    {
        if (selectedSpool == null) return;

        await FilamentService.DeleteSpoolAsync(selectedSpool.Id);
        
        // Reload filament
        if (Filament != null)
        {
            var updated = await FilamentService.GetFilamentByIdAsync(Filament.Id);
            if (updated != null && updated.Spools.Any())
            {
                Filament = updated;
                selectedSpool = Filament.Spools.FirstOrDefault();
                LoadSpoolForEditing();
            }
            else
            {
                // No spools left, close modal
                await Close();
            }
        }
        
        await OnUpdate.InvokeAsync();
    }

    private async Task DeleteFilament()
    {
        if (Filament == null) return;

        await FilamentService.DeleteFilamentAsync(Filament.Id);
        await OnUpdate.InvokeAsync();
        await Close();
    }

    private async Task Close()
    {
        await OnClose.InvokeAsync();
    }

    private void HandleBackdropClick()
    {
        _ = Close();
    }

    private string GetSpoolStatus(Spool spool)
    {
        var status = ThresholdService.GetStatus(spool.WeightRemaining);
        return status == "critical" ? "danger" : (status == "low" ? "warn" : "ok");
    }

    private string GetSpoolStatusText(Spool spool)
    {
        var status = ThresholdService.GetStatus(spool.WeightRemaining);
        return status == "critical" ? "Critical" : (status == "low" ? "Low" : "OK");
    }
    
    private void OnNewSpoolTypeChanged(ChangeEventArgs e)
    {
        newSpoolIsRefill = e.Value?.ToString() == "true";
    }

    private void OnEditSpoolTypeChanged(ChangeEventArgs e)
    {
        editIsRefill = e.Value?.ToString() == "true";
    }

    private void ToggleAddSpool()
    {
        showAddSpool = !showAddSpool;
        
        // Reset form when opening
        if (showAddSpool)
        {
            newSpoolIsRefill = false;
            newSpoolTotalWeight = 1000;
            newSpoolWeightRemaining = 1000;
            newSpoolMaterial = "";
            newSpoolIsReusable = false;
            newSpoolPurchasePrice = null;
        }
    }
    
    private async Task AddNewSpool()
    {
        if (Filament == null) return;
        
        var newSpool = new Spool
        {
            FilamentId = Filament.Id,
            IsRefill = newSpoolIsRefill,
            TotalWeight = newSpoolTotalWeight,
            WeightRemaining = newSpoolWeightRemaining,
            SpoolMaterial = string.IsNullOrWhiteSpace(newSpoolMaterial) ? null : newSpoolMaterial,
            IsReusable = newSpoolIsReusable,
            PurchasePricePerKg = newSpoolPurchasePrice,
            DateAdded = DateTime.Now
        };
        
        await FilamentService.AddSpoolToFilamentAsync(Filament.Id, newSpool);
        
        // Reload filament to get updated spools and calculated price
        var updated = await FilamentService.GetFilamentByIdAsync(Filament.Id);
        if (updated != null)
        {
            Filament = updated;
            // Select the newly added spool
            selectedSpool = Filament.Spools.OrderByDescending(s => s.DateAdded).FirstOrDefault();
            LoadSpoolForEditing();
            LoadFilamentForEditing();
        }
        
        showAddSpool = false;
        await OnUpdate.InvokeAsync();
        StateHasChanged();
        
        usageMessage = "New spool added successfully!";
        _ = Task.Delay(3000).ContinueWith(_ =>
        {
            usageMessage = "";
            InvokeAsync(StateHasChanged);
        });
    }
}
